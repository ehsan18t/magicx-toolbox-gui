# Windows Update Tweaks - Control Windows Update behavior and delivery

category:
  id: windows_update
  name: "Windows Update"
  description: "Control Windows Update behavior and delivery optimization"
  icon: "mdi:update"
  order: 7

tweaks:
  - id: disable_store_auto_updates
    name: "Disable Store Auto Updates"
    description: "Prevent Microsoft Store from automatically updating apps"
    risk_level: low
    requires_admin: true
    requires_reboot: false
    requires_system: false
    is_toggle: true
    info: "Apps will only update when you manually check for updates in the Store"
    options:
      - label: "Auto Updates Disabled"
        registry_changes:
          - hive: HKLM
            key: "Software\\Policies\\Microsoft\\WindowsStore"
            value_name: "AutoDownload"
            value_type: "REG_DWORD"
            value: 2
      - label: "Auto Updates Enabled"
        registry_changes:
          - hive: HKLM
            key: "Software\\Policies\\Microsoft\\WindowsStore"
            value_name: "AutoDownload"
            value_type: "REG_DWORD"
            value: 4

  - id: disable_peer_update_delivery
    name: "Disable P2P Update Delivery"
    description: "Disable Windows Update peer-to-peer delivery optimization"
    risk_level: low
    requires_admin: false
    requires_reboot: false
    requires_system: false
    is_toggle: true
    info: "Prevents Windows from downloading/uploading updates from/to other PCs"
    options:
      - label: "P2P Delivery Disabled"
        registry_changes:
          - hive: HKCU
            key: "Software\\Microsoft\\Windows\\CurrentVersion\\DeliveryOptimization"
            value_name: "SystemSettingsDownloadMode"
            value_type: "REG_DWORD"
            value: 0
      - label: "P2P Delivery Enabled"
        registry_changes:
          - hive: HKCU
            key: "Software\\Microsoft\\Windows\\CurrentVersion\\DeliveryOptimization"
            value_name: "SystemSettingsDownloadMode"
            value_type: "REG_DWORD"
            value: 3

  - id: disable_ms_products_auto_update
    name: "Disable MS Products Auto Update"
    description: "Disable automatic updates for other Microsoft products via Windows Update"
    risk_level: low
    requires_admin: true
    requires_reboot: false
    requires_system: false
    is_toggle: true
    options:
      - label: "MS Products Auto Update Disabled"
        registry_changes:
          - hive: HKLM
            key: "Software\\Microsoft\\Windows\\CurrentVersion\\WindowsUpdate\\Services\\7971f918-a847-4430-9279-4a52d1efe18d"
            value_name: "RegisteredWithAU"
            value_type: "REG_DWORD"
            value: 0
      - label: "MS Products Auto Update Enabled"
        registry_changes:
          - hive: HKLM
            key: "Software\\Microsoft\\Windows\\CurrentVersion\\WindowsUpdate\\Services\\7971f918-a847-4430-9279-4a52d1efe18d"
            value_name: "RegisteredWithAU"
            value_type: "REG_DWORD"
            value: 1

  - id: disable_driver_updates
    name: "Disable Driver Updates via Windows Update"
    description: "Prevent Windows Update from automatically installing driver updates"
    risk_level: medium
    requires_admin: true
    requires_reboot: false
    requires_system: false
    is_toggle: true
    info: "Useful if you prefer to install drivers manually from manufacturer"
    options:
      - label: "Driver Updates Disabled"
        registry_changes:
          - hive: HKLM
            key: "Software\\Policies\\Microsoft\\Windows\\WindowsUpdate"
            value_name: "ExcludeWUDriversInQualityUpdate"
            value_type: "REG_DWORD"
            value: 1
      - label: "Driver Updates Enabled"
        registry_changes:
          - hive: HKLM
            key: "Software\\Policies\\Microsoft\\Windows\\WindowsUpdate"
            value_name: "ExcludeWUDriversInQualityUpdate"
            value_type: "REG_DWORD"
            value: 0

  - id: disable_windows_update_complete
    name: "Disable Windows Update (Complete)"
    description: "Completely disable the Windows Update service and automatic updates"
    risk_level: high
    requires_admin: true
    requires_reboot: false
    requires_system: false
    is_toggle: true
    info: "Stops and disables the Windows Update service. Updates must be installed manually. Use with caution - security updates will not be installed automatically."
    options:
      - label: "Windows Update Disabled"
        post_powershell:
          - "$path='\\Microsoft\\Windows\\UpdateOrchestrator\\'; $fail=0; Get-ScheduledTask -TaskPath $path -ErrorAction SilentlyContinue | Where-Object {$_.TaskName -match 'Schedule Scan|USO|MusNotification|Reboot|Refresh'} | ForEach-Object { try { Disable-ScheduledTask -InputObject $_ -ErrorAction Stop; if ((Get-ScheduledTask -InputObject $_).State -ne 'Disabled') { $fail=1 } } catch { $fail=1 } }; exit $fail"
        registry_changes:
          - hive: HKLM
            key: "Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU"
            value_name: "AUOptions"
            value_type: "REG_DWORD"
            value: 1
          - hive: HKLM
            key: "Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU"
            value_name: "NoAutoUpdate"
            value_type: "REG_DWORD"
            value: 1
          - hive: HKLM
            key: "Software\\Policies\\Microsoft\\Windows\\WindowsUpdate"
            value_name: "SetDisableUXWUAccess"
            value_type: "REG_DWORD"
            value: 1
        service_changes:
          - name: "wuauserv"
            startup: disabled
            skip_validation: true
          - name: "WaaSMedicSvc"
            startup: disabled
          - name: "UsoSvc"
            startup: disabled
      - label: "Windows Update Enabled"
        post_powershell:
          - "$path='\\Microsoft\\Windows\\UpdateOrchestrator\\'; $fail=0; Get-ScheduledTask -TaskPath $path -ErrorAction SilentlyContinue | Where-Object {$_.TaskName -match 'Schedule Scan|USO|MusNotification|Reboot|Refresh'} | ForEach-Object { try { Enable-ScheduledTask -InputObject $_ -ErrorAction Stop; if ((Get-ScheduledTask -InputObject $_).State -ne 'Ready') { $fail=1 } } catch { $fail=1 } }; exit $fail"
        registry_changes:
          - hive: HKLM
            key: "Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU"
            value_name: "AUOptions"
            value_type: "REG_DWORD"
            value: 2
          - hive: HKLM
            key: "Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU"
            value_name: "NoAutoUpdate"
            value_type: "REG_DWORD"
            value: 0
          - hive: HKLM
            key: "Software\\Policies\\Microsoft\\Windows\\WindowsUpdate"
            value_name: "SetDisableUXWUAccess"
            value_type: "REG_DWORD"
            value: 0
        service_changes:
          - name: "wuauserv"
            startup: manual
            skip_validation: true
          - name: "WaaSMedicSvc"
            startup: manual
          - name: "UsoSvc"
            startup: automatic
